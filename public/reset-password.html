<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha - AgendaPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #704abf 0%, #9c6fff 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Criar Nova Senha</h1>
            <p class="text-white/80">Digite e confirme sua nova senha abaixo.</p>
        </div>

        <div id="timer-container" class="text-center mb-4">
            <p class="text-white/90">Este link expira em: <span id="timer" class="font-bold text-lg">10:00</span></p>
        </div>

        <form id="reset-form" class="space-y-4">
            <div>
                <label for="password" class="block text-white/90 text-sm font-medium mb-2">
                    Nova Senha
                </label>
                <input type="password" id="password" required minlength="6"
                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60"
                       placeholder="Mínimo 6 caracteres">
            </div>
            <div>
                <label for="password-confirm" class="block text-white/90 text-sm font-medium mb-2">
                    Confirme a Nova Senha
                </label>
                <input type="password" id="password-confirm" required
                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60"
                       placeholder="Repita a senha">
            </div>
            <button type="submit" id="submit-button"
                    class="w-full bg-white text-[#704abf] font-semibold py-3 px-4 rounded-lg transition-all duration-200">
                Salvar Nova Senha
            </button>
        </form>
        <div id="message" class="mt-4 text-center text-white"></div>
        
        <div class="text-center mt-6">
            <a href="login.html" class="inline-block px-6 py-2 bg-white/20 hover:bg-white/30 text-white/90 font-medium rounded-lg transition-colors duration-200">
                Voltar para o Login
            </a>
        </div>
    </div>

    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl text-center text-white max-w-sm w-full mx-4">
            <div class="w-16 h-16 bg-red-500/80 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-400/50">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-white"></i>
            </div>
            <h3 id="modal-title" class="text-2xl font-bold mb-2">Ocorreu um Erro</h3>
            <p id="modal-message" class="text-white/80 mb-8">Não foi possível redefinir sua senha.</p>
            <button id="modal-action-button" class="w-full bg-white text-[#704abf] font-semibold py-3 px-4 rounded-lg transition-all duration-200">
                Solicitar Novo Link
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (elementos do DOM)
            const form = document.getElementById('reset-form');
            const messageDiv = document.getElementById('message');
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('password-confirm');
            const submitButton = document.getElementById('submit-button');
            const timerDisplay = document.getElementById('timer');

            // Elementos do Modal
            const errorModal = document.getElementById('error-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalActionButton = document.getElementById('modal-action-button');

            // Função para exibir o modal
            const showModal = (title, msg) => {
                modalTitle.textContent = title;
                modalMessage.textContent = msg;
                errorModal.classList.remove('hidden');
                lucide.createIcons(); // Recria o ícone dentro do modal
            };
            
            // Evento do botão do modal
            modalActionButton.addEventListener('click', () => {
                window.location.href = '/solicitar-recuperacao.html';
            });

            // Lógica do Cronômetro
            let timeLeft = 600; 
            const countdown = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    timerDisplay.textContent = '00:00';
                    form.classList.add('hidden'); // Esconde o formulário
                    showModal('Tempo Esgotado', 'Seu link de redefinição de senha expirou. Por favor, solicite um novo.');
                }
            }, 1000);

            // Evento de submit do formulário
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageDiv.textContent = '';

                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (!token) {
                    showModal('Erro', 'O token de redefinição não foi encontrado na URL.');
                    return;
                }

                if (passwordInput.value !== passwordConfirmInput.value) {
                    messageDiv.textContent = 'As senhas não coincidem.';
                    return;
                }

                try {
                    const response = await fetch(`/api/auth/reset-password/${token}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput.value }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        clearInterval(countdown);
                        messageDiv.textContent = 'Senha alterada com sucesso! Redirecionando para o login...';
                        messageDiv.classList.add('text-green-300');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 3000);
                    } else {
                        // Usa o modal para exibir o erro da API
                        throw new Error(data.message || 'Não foi possível redefinir a senha.');
                    }
                } catch (error) {
                    // Usa o modal para exibir o erro
                    showModal('Token Inválido', error.message);
                }
            });
            lucide.createIcons();
        });
    </script>
</body>
</html>